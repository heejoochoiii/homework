<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ weather.city }} 날씨</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f4f6f8;
            padding: 30px;
            color: #222;
        }
        h1 {
            font-size: 28px;
            margin-bottom: 20px;
        }
        form {
            margin-bottom: 16px;
            position: relative;
        }
        input[type="text"] {
            padding: 8px;
            font-size: 16px;
            width: 200px;
        }
        button {
            padding: 8px 12px;
            font-size: 16px;
            margin-left: 6px;
        }
        #suggestions {
            position: absolute;
            top: 38px;
            left: 0;
            border: 1px solid #ccc;
            background: #fff;
            width: 200px;
            z-index: 10;
            max-height: 150px;
            overflow-y: auto;
        }
        .suggestion-item {
            padding: 6px 8px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #eee;
        }
        ul {
            list-style: none;
            padding-left: 0;
            font-size: 17px;
            margin-top: 20px;
        }
        li {
            margin-bottom: 8px;
        }
        li strong {
            font-weight: bold;
        }
        .note {
            font-size: 14px;
            color: gray;
        }
        .error {
            color: red;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <h1>{{ weather.city }}의 현재 날씨</h1>

    <form method="GET" action="/">
        <input type="text" name="city" id="city-input" placeholder="도시 이름 입력" autocomplete="off" required>
        <button type="submit">날씨 조회</button>
        <div id="suggestions"></div>
    </form>

    <p class="note">도시명이 인식되지 않으면 <strong>영문으로, 첫 글자를 대문자로</strong> 입력해주세요. (예: Busan)</p>

    {% if weather.error %}
        <p class="error">{{ weather.error }}</p>
    {% else %}
    <ul>
        <li><strong>기온:</strong> <span id="temp">{{ weather.temperature }}</span>°C</li>
        <li><strong>강수량(1시간):</strong> <span id="rain">{{ weather.rain }}</span> mm</li>
        <li><strong>습도:</strong> <span id="humidity">{{ weather.humidity }}</span>%</li>
        <li><strong>설명:</strong> <span id="desc">{{ weather.description }}</span></li>
    </ul>
    {% endif %}

    <script>
        const input = document.getElementById('city-input');
        const suggestions = document.getElementById('suggestions');

        input.addEventListener('input', () => {
            const query = input.value;
            if (query.length < 1) {
                suggestions.innerHTML = '';
                return;
            }

            fetch(`/autocomplete?q=${query}`)
                .then(res => res.json())
                .then(data => {
                    suggestions.innerHTML = '';
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.classList.add('suggestion-item');
                        div.textContent = item;
                        div.addEventListener('click', () => {
                            input.value = item;
                            suggestions.innerHTML = '';
                        });
                        suggestions.appendChild(div);
                    });
                });
        });
    </script>

    <script>
        // 1분마다 날씨 자동 갱신
        function fetchWeather() {
            const params = new URLSearchParams(window.location.search);
            const city = params.get('city') || 'Seoul';

            fetch(`/weather-data?city=${city}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.error) {
                        document.getElementById('temp').innerText = data.temperature;
                        document.getElementById('rain').innerText = data.rain;
                        document.getElementById('humidity').innerText = data.humidity;
                        document.getElementById('desc').innerText = data.description;
                    }
                });
        }

        fetchWeather();
        setInterval(fetchWeather, 60000); // 1분마다 갱신
    </script>
</body>
</html>
